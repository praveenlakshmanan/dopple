

<!DOCTYPE html>
<!--[if lt IE 7]>
<html class="no-js lt-ie9 lt-ie8 lt-ie7">
   <![endif]-->
<!--[if IE 7]>
   <html class="no-js lt-ie9 lt-ie8">
      <![endif]-->
<!--[if IE 8]>
      <html class="no-js lt-ie9">
         <![endif]-->
<!--[if gt IE 8]><!-->
<html class="no-js">
<!--<![endif]-->
<head>
<meta charset="utf-8">
<meta http-equiv="X-UA-Compatible" content="IE=edge,chrome=1">
<meta name="viewport" content="width=device-width">
<meta http-equiv='cache-control' content='no-cache'>
<meta http-equiv='expires' content='0'>
<meta http-equiv='pragma' content='no-cache'>
<title>Dopple Machine Log Analysis</title>
<link rel="stylesheet" href="css/bootstrap.light.min.css" title="Light">

<link rel="stylesheet" href="css/timepicker.css">
<link rel="stylesheet" href="css/animate.min.css">
<link rel="stylesheet" href="css/normalize.min.css">
 <!--<script src="https://ajax.googleapis.com/ajax/libs/jquery/1.11.2/jquery.min.js"></script>-->
  <script src="js/jquery-1.11.js"></script> 
   <!--  <script type="text/javascript" src="js/html2canvas.js"></script> -->
<script type = "text/javascript" >

   function preventBack(){window.history.forward();}
	    setTimeout("preventBack()", 0);
	    window.onunload=function(){null};
	    
</script>
<script type="text/javascript">

$(function(){
	$("#alert-container").hide();
	$(window).on('hashchange', function(e){
		dashboardAuthenticate();
	});
	
	
})

</script>
<script type="text/javascript">
var authEncodedString;
function defaultDashboard(){
	
	var path = document.getElementById("save_input_field").value;
	
	path = "index.html#/dashboard/elasticsearch/"+path+"@"+authEncodedString;
	var xmlhttpdashboard;
	if (window.XMLHttpRequest){// code for IE7+, Firefox, Chrome, Opera, Safari
		xmlhttpdashboard=new XMLHttpRequest();
		  }else{// code for IE6, IE5
			  xmlhttpdashboard=new ActiveXObject("Microsoft.XMLHTTP");
		  }
	xmlhttpdashboard.onreadystatechange=function()
	  {
		if (xmlhttpdashboard.readyState==4 && xmlhttpdashboard.status==200){
			$("#alert-container").show();
			//var alertmsg = document.getElementById("alert-container");
			//alertmsg.style.display = "block";
			document.getElementById("alert-container").innerHTML = "Saved successfully";
			var fade_out = function() {
				//alertmsg.style.display = "none";
				$("#alert-container").hide();	
			}
            setTimeout(fade_out, 5000);
			//alert("Saved successfully");
			}
			
		} 
	  
	xmlhttpdashboard.open("POST","setDefaultDashboard",true);
	
	var newpath = "newpath="+encodeURIComponent(path);
	xmlhttpdashboard.setRequestHeader("Content-type", "application/x-www-form-urlencoded");
	xmlhttpdashboard.send(newpath);
}
function logOut(){
	
	var xmlhttpout;
	if (window.XMLHttpRequest){// code for IE7+, Firefox, Chrome, Opera, Safari
	  xmlhttpout=new XMLHttpRequest();
	  }else{// code for IE6, IE5
	  xmlhttpout=new ActiveXObject("Microsoft.XMLHTTP");
	  }

	 xmlhttpout.onreadystatechange=function()
	  {
		if (xmlhttpout.readyState==4 && xmlhttpout.status==200){
			if(xmlhttpout.responseText){
				window.location.assign("login.html");
			}
			
		} 
	  }
		xmlhttpout.open("GET","logout",true);
		xmlhttpout.send();
		

		
}
var authEncoded;
var default_route;
var site;
var accessibility;
var userName;
var security = "";
var loccode;
var indexVar;
function createDashboard(){
	window.location.assign("index.html#/dashboard/file/blank.json?index="+indexVar);
}
var Base64={_keyStr:"ABCDEFGHIJKLMNOPQRSTUVWXYZabcdefghijklmnopqrstuvwxyz0123456789+/=",encode:function(e){var t="";var n,r,i,s,o,u,a;var f=0;e=Base64._utf8_encode(e);while(f<e.length){n=e.charCodeAt(f++);r=e.charCodeAt(f++);i=e.charCodeAt(f++);s=n>>2;o=(n&3)<<4|r>>4;u=(r&15)<<2|i>>6;a=i&63;if(isNaN(r)){u=a=64}else if(isNaN(i)){a=64}t=t+this._keyStr.charAt(s)+this._keyStr.charAt(o)+this._keyStr.charAt(u)+this._keyStr.charAt(a)}return t},decode:function(e){var t="";var n,r,i;var s,o,u,a;var f=0;e=e.replace(/[^A-Za-z0-9\+\/\=]/g,"");while(f<e.length){s=this._keyStr.indexOf(e.charAt(f++));o=this._keyStr.indexOf(e.charAt(f++));u=this._keyStr.indexOf(e.charAt(f++));a=this._keyStr.indexOf(e.charAt(f++));n=s<<2|o>>4;r=(o&15)<<4|u>>2;i=(u&3)<<6|a;t=t+String.fromCharCode(n);if(u!=64){t=t+String.fromCharCode(r)}if(a!=64){t=t+String.fromCharCode(i)}}t=Base64._utf8_decode(t);return t},_utf8_encode:function(e){e=e.replace(/\r\n/g,"\n");var t="";for(var n=0;n<e.length;n++){var r=e.charCodeAt(n);if(r<128){t+=String.fromCharCode(r)}else if(r>127&&r<2048){t+=String.fromCharCode(r>>6|192);t+=String.fromCharCode(r&63|128)}else{t+=String.fromCharCode(r>>12|224);t+=String.fromCharCode(r>>6&63|128);t+=String.fromCharCode(r&63|128)}}return t},_utf8_decode:function(e){var t="";var n=0;var r=c1=c2=0;while(n<e.length){r=e.charCodeAt(n);if(r<128){t+=String.fromCharCode(r);n++}else if(r>191&&r<224){c2=e.charCodeAt(n+1);t+=String.fromCharCode((r&31)<<6|c2&63);n+=2}else{c2=e.charCodeAt(n+1);c3=e.charCodeAt(n+2);t+=String.fromCharCode((r&15)<<12|(c2&63)<<6|c3&63);n+=3}}return t}}
var currentUrl = document.URL; 

if(currentUrl.indexOf("?user") >= 0){
	
}else{
	var xmlhttp;
	if (window.XMLHttpRequest){// code for IE7+, Firefox, Chrome, Opera, Safari
		  xmlhttp=new XMLHttpRequest();
		  }else{// code for IE6, IE5
		  xmlhttp=new ActiveXObject("Microsoft.XMLHTTP");
		  }

	xmlhttp.onreadystatechange=function()
	  {
		if (xmlhttp.readyState==4 && xmlhttp.status==200){ 
			sessionValue()
		}
		}
		xmlhttp.open("GET","DefaultDashboard",true);
		xmlhttp.send();
}
/* 
 */
	function sessionValue(){
	    var user_detail = $.parseJSON(xmlhttp.responseText);
	    userName = user_detail.name;
	    authEncoded = Base64.encode("site"+userName);
		default_route = user_detail.default_dashboard;
		security = user_detail.loccode;
		
		if(security != "all"){
			var locationSplit = security.split(",")
			if(locationSplit.length > 1){
				site = [];
				authEncodedString = [];
				loccode = [];
				for(var i=0;i<locationSplit.length;i++){
					site.push("site"+locationSplit[i]);
					//alert(site);
					authEncodedString.push(Base64.encode("site"+locationSplit[i]));
					//authEncodedString.push(site);
					loccode.push("doppleml-"+locationSplit[i]+"*"); 
				}
				site.toString();
				authEncodedString.toString();
				loccode.toString();
				indexVar = loccode;
			}else{
				site = "site"+security;
				authEncodedString = Base64.encode("site"+security);
				
			    loccode = security; 
				indexVar = "doppleml-"+security+"*";
			}
		 }else{
		 loccode = "";
		 indexVar =  "doppleml-*"
		 authEncodedString = "";
		}
		 //alert(site);
		 if(user_detail.privilege == "E"){
			 accessibility = "true";
		 }else{
			 accessibility = "false";
		 }
		
		//alert(default_route);
		
		//Define the string
	}
	function urlSecurity(){
		if(security == ""){
			var xmlhttp;
			if (window.XMLHttpRequest){// code for IE7+, Firefox, Chrome, Opera, Safari
				  xmlhttp=new XMLHttpRequest();
				  }else{// code for IE6, IE5
				  xmlhttp=new ActiveXObject("Microsoft.XMLHTTP");
				  }
			if(currentUrl.indexOf("?user") >= 0){
				var user = currentUrl.split("?user=");
				var value = user[user.length -1].split("@");
				xmlhttp.onreadystatechange=function()
				  {
					if (xmlhttp.readyState==4 && xmlhttp.status==200){ alert(xmlhttp.responseText);
						if(xmlhttp.responseText == "false"){
							logOut();
						}else{ 
						var user_detail = $.parseJSON(xmlhttp.responseText);
						
						    userName = user_detail.name;
						    var authEncoded = Base64.encode("site"+user_detail.name);
						 
						    if(value[value.length - 1] != authEncoded){
						    	logOut();
						    }
					}
					}
					}
					xmlhttp.open("POST","DefaultDashboard",true);
					xmlhttp.setRequestHeader("Content-type", "application/x-www-form-urlencoded");
					var parameters = "user="+encodeURIComponent(value[0]);
					
					xmlhttp.send(parameters);
			}else{
			logOut();
			}
		}
		
	}
	
	function dashboardAuthenticate(){ 
		if(authEncodedString != ""){
		var url = document.URL.split("/");
		if(url[url.length-1].indexOf("@") == -1){
			if(url[url.length-1].indexOf("?")!=-1){
			var path = url[url.length-1].split("?");
			var newpath = path[path.length-1].split("=");
			if(newpath[newpath.length-1] != indexVar){
				alert("Invalid Autentication");
				logOut();
			}
			}
		}else{
		var path = url[url.length-1].split("@");
		
		if(path.length > 1){
		
		
		//Encode the String
		//var encodedString = Base64.encode(site);
		

		//Decode the String
		
		var decodedString = Base64.decode(path[path.length-1]);
		if(site != decodedString){
			alert("Invalid Autentication");
			logOut();
		}
		}else{
			alert("Invalid Autentication");
			logOut();
		}
		}
	}
	}


</script>
<script src="vendor/require/require.js"></script>
<script src="app/components/require.config.js"></script>
<script>require(['app'], function () {})</script>


</head>
<body>
	<noscript>
		<div class="container">
			<center>
				<h3>You must enable javascript to use Kibana</h3>
			</center>
		</div>
	</noscript>
	<link rel="stylesheet"
		ng-href="css/bootstrap.{{dashboard.current.style||'dark'}}.min.css">
	<link rel="stylesheet" href="css/bootstrap-responsive.min.css">
	<link rel="stylesheet" href="css/font-awesome.min.css">
	<!-- <link href='http://fonts.googleapis.com/css?family=Montserrat'
		rel='stylesheet' type='text/css'>
	<link href='http://fonts.googleapis.com/css?family=Quicksand'
		rel='stylesheet' type='text/css'> -->
	<style type="text/css">
	@font-face {
  font-family: 'Montserrat';
  font-style: normal;
  font-weight: 400;
  src: local('Montserrat-Regular'), url(font/zhcz-_WihjSQC0oHJ9TCYBsxEYwM7FgeyaSgU71cLG0.woff) format('woff');
}
@font-face {
  font-family: 'Quicksand';
  font-style: normal;
  font-weight: 400;
  src: local('Quicksand Regular'), local('Quicksand-Regular'), url(font/sKd0EMYPAh5PYCRKSryvWz8E0i7KZn-EPnyo3HZu7kw.woff) format('woff');
}
.bgWarning {
	background: none repeat scroll 0 0 #F26A5D;
}

.bgPrimary {
	background: none repeat scroll 0 0 #FFCA55;
}

.bgSuccess {
	background: none repeat scroll 0 0 #A0D8D4;
}

#brand,.panel-title {
	font-family: 'Montserrat', sans-serif;
}

body,input[type="text"] {
	font-family: 'Quicksand', sans-serif;
}
select{
	font-family: 'Quicksand', sans-serif;
}
button{
font-family: 'Quicksand', sans-serif;
}
</style>
	<div style="width:100%;height:20px;background:#699e00;font-weight: bold;padding-left:10px" id="alert-container"></div>
	<div ng-cloak="" ng-repeat="alert in dashAlerts.list"
		class="alert-{{alert.severity}} dashboard-notice" ng-show="$last">
		<button type="button" class="close" ng-click="dashAlerts.clear(alert)"
			style="padding-right: 50px">&times;</button>
		<strong>{{alert.title}}</strong> <span ng-bind-html="alert.text"></span>
		<div style="padding-right: 10px" class="pull-right small">{{$index
			+ 1}} alert(s)</div>
	</div>
	<div ng-cloak="" class="navbar navbar-static-top">
		<div class="navbar-inner">
			<div class="container-fluid">
				<span id="brand" value={{dashboard.current.title}} class="brand"><img
					src="img/small.png"
					bs-tooltip="'Kibana '+(kbnVersion=='@REV@'?'master':kbnVersion)"
					data-placement="bottom">&nbsp;Dopple -
					{{dashboard.current.title}}</span>
				<ul class="nav pull-right" ng-controller="dashLoader"
					ng-init="init()" ng-include="'app/partials/dashLoader.html'"></ul>

			</div>
		</div>
	</div>
	


	<div ng-cloak="" ng-view="" ></div>

</body>
<script type="text/javascript">
//setTimeout(urlSecurity(),10000);

</script>
</html>

